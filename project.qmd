---
format:
  pdf:
    papersize: A4
execute:
  echo: true
  warning: false
  message: false
---

{{< pagebreak >}} 

# Appendix

## A1. Data Preparation

```{r}
# R packages
library(ggplot2)
library(tidyverse)
library(Hmisc)
library(PMXForest)
library(patchwork)
library(kableExtra)
library(ggpubr)
library(scales)
library(ggsurvfit)
library(survival)
library(survminer)
```

```{r}
# data preparation
data <- read.table("dataset.txt", sep = " ",       # space-separated
                  header = TRUE, na.strings = ".") # treat "." as NA

LLOQ <- 1 # mg/L

data <- data %>% mutate(DOSE = as.numeric(DOSE),
                        EVID = case_when(is.na(CONC) & DOSE!=0 ~ 1,
                                         CONC>=0 ~ 0,
                                         is.na(CONC) & is.na(DOSE) ~ 2),
                        BLQ = case_when(CONC<1 ~ 1,
                                        CONC>=1 ~ 0,
                                        is.na(CONC) ~ 0),
                        CONC_M7 = ifelse(CONC < 1, 0, CONC)) %>%
  group_by(ID) %>%  
  fill(c(ALB, BW, CREAT),.direction = "downup") %>%
  arrange(TIME, .by_group = TRUE) %>%
  mutate(ADA = case_when(
    ID %in% 71:75 ~ as.integer(cumany(ADA == 1)),
    TRUE          ~ ADA),
         COL = if_else(cummax(COL == 1L) == 1L, 1L, COL)) %>%
  ungroup()

data$DOSE = data$DOSE * data$BW # dose (mg) = dose (mg/kg) * body weight (kg)

write.csv(data, file = "dataset_clean.csv", quote = FALSE,
          na = ".", row.names = FALSE)
```

{{< pagebreak >}} 

## A2. Final Model {.unnumbered .unlisted}

### A2.1. Two-Compartment Target-Mediated Drug Disposition Model with Michaelis-Menten Approximation

```{fortran}
#| eval: false
$PROBLEM PMX001 Two Compartment TMDD Model
;; 2 assumptions:
;; 1. Free ligand concentration is much larger than total target conc.
;; 2. Vmax = cst => Rtot = cst => target degradation rate (kout)
;;    = ligand-target complex internalization rate (kint)

$INPUT DUMMY=DROP ID TIME WEEK DOSE=AMT RATE CONC=DROP ADA BW ALB SEX AGE 
       CREAT COL EVID BLQ CONC_M7=DV

$DATA dataset_clean.csv IGNORE=@

$ABBR DERIV2=NO

$SUBROUTINES
ADVAN13
TOL=5

$MODEL
NCOMP=3                      ; number of compartments
COMP=(DOSE, DEFDOSE, DEFOBS) ; first (central) compartment
COMP=(PERIPH)                ; second (peripheral) compartment
COMP=(AUC)                   ; continuous AUC integration

$PK
IF (EVID.EQ.1) LASTDOSE = TIME
TAD = TIME - LASTDOSE

  TVCL = THETA(1)
TVVMAX = THETA(2)
  TVKM = THETA(3)
  TVV1 = THETA(4)
  TVV2 = THETA(5)
   TVQ = THETA(6)

CLALB = ((ALB/31.85)**THETA(7))
   
  CL = TVCL   * EXP(ETA(1)) * CLALB
VMAX = TVVMAX
  KM = TVKM
  V1 = TVV1
  V2 = TVV2
   Q = TVQ
 
 K10 = CL/V1
 K12 = Q/V1
 K21 = Q/V2
 
  S1 = V1/1 ; scale prediction based on DOSE (mg) and DV (mg/L)
  S2 = V2/1

$THETA ; values are determined in 3 iterations
(0.01,     0.944,       2.3) ; CL (L/d)
(0.5,      1.38,          3) ; VMAX
(0.001,    0.00758,    0.02) ; KM
(0.5,      4.42,          9) ; V1 (L)
(0.00001,  0.000307, 0.0006) ; V2
(0.1,     13,            30) ; Q
(-100,    -3.41223,      50) ; CLALB

$DES DADT(1) = -K10*A(1) -K12*A(1) +K21*A(2) -VMAX*A(1)/(KM*V1 + A(1))
     DADT(2) =            K12*A(1) -K21*A(2)                          
        cAUC = A(1)/V1
     DADT(3) = cAUC

$ERROR
IPRED = F
LLOQ = 1  ; (mg/L)

; --- Residual error SDs ---
PROP_SD = SIGMA(1)
ADD_SD  = SIGMA(2)

; --- BLQ inflation (gentle, stable) ---
IF (BLQ.EQ.1) ADD_SD = ADD_SD + LLOQ

; --- Final residual error ---
W = SQRT(ADD_SD**2+PROP_SD**2)

IF (W.LE.0.000001) W=0.000001 ; Protective code

IRES=DV-IPRED
IWRES=IRES/W
Y = IPRED * (1 + EPS(1)) + EPS(2)

$OMEGA 0.366 ; IIV CL

$SIGMA    ; residual variability
0.327     ; EPS(1), proportional
1E-13 FIX ; EPS(2); additive, required by M7+ censoring method

$EST
METHOD=1 INTERACTION; FOCE-I
MAXEVAL=9999
SIG=3
SIGL=3
PRINT=5

$COVARIANCE PRINT=E UNCONDITIONAL MATRIX=S

$TABLE ; output table for standard outcomes
ID TIME TAD DV EVID PRED IPRED WRES IWRES RES IRES CWRES CRES NOPRINT
ONEHEADER FILE=run16_sdtab

$TABLE ; output table for parameters and covariates
ID cAUC CL VMAX KM V1 V2 Q K10 K12 K21 ADA SEX COL BW ALB AGE CREAT NOPRINT
NOAPPEND ONEHEADER FILE=run16_pa_cov
```

{{< pagebreak >}} 

### A2.2. Two-Compartment Model with Linear Elimination

```{fortran}
#| eval: false
$PROBLEM PMX001 Two Compartment Linear Elimination

$INPUT DUMMY=DROP ID TIME WEEK DOSE=AMT RATE CONC=DROP ADA BW ALB SEX AGE
       CREAT COL EVID BLQ CONC_M7=DV

$DATA dataset_clean.csv IGNORE=@

$ABBR DERIV2=NO

$SUBROUTINES
ADVAN13
TOL=5

$MODEL
NCOMP=3
COMP=(DOSE, DEFDOSE, DEFOBS)
COMP=(PERIPH)
COMP=(AUC)

$PK
IF (EVID.EQ.1) LASTDOSE = TIME
TAD = TIME - LASTDOSE

TVCL = THETA(1)
TVV1 = THETA(2)
TVV2 = THETA(3)
 TVQ = THETA(4)

IF(ADA.EQ.0) CLADA = 1  ; Most common
IF(ADA.EQ.1) CLADA = ( 1 + THETA(5))
V1ALB = ( 1 + THETA(6)*(ALB - 31.84))
   
  CL = TVCL * EXP(ETA(1)) * CLADA
  V1 = TVV1 * EXP(ETA(2)) * V1ALB
  V2 = TVV2
   Q = TVQ
 
 K10 = CL/V1
 K12 = Q/V1
 K21 = Q/V2
 
  S1 = V1/1 ; scale prediction based on DOSE (mg) and DV (mg/L)
  S2 = V2/1

$THETA ; values are determined in 3 iterations
(0.001,   1.41,      3) ; CL (L/d)
(0.001,   4.73,      7) ; V1 (L)
(0.01,    0.231,   0.8) ; V2
(0.001,   2.15,      5) ; Q
(0.001,   5.78,      8) ; CLADA
(-0.140, -0.127, -0.001) ; V1ALB1

$DES DADT(1) = -K10*A(1) -K12*A(1) +K21*A(2) ; ODE central    compartment
     DADT(2) =            K12*A(1) -K21*A(2) ; ODE peripheral compartment
        cAUC = A(1)/V1                       ; calculates cumulative AUC
     DADT(3) = cAUC                          ; continuous AUC integration

$ERROR
IPRED = F
LLOQ = 1  ; (mg/L)

; --- Residual error SDs ---
PROP_SD = SIGMA(1)
ADD_SD  = SIGMA(2)

; --- BLQ inflation (gentle, stable) ---
IF (BLQ.EQ.1) ADD_SD = ADD_SD + LLOQ

; --- Final residual error ---
W = SQRT(ADD_SD**2+PROP_SD**2)

IF (W.LE.0.000001) W=0.000001 ; Protective code

IRES=DV-IPRED
IWRES=IRES/W
Y = IPRED * (1 + EPS(1)) + EPS(2)

$OMEGA
0.608 ; IIV CL
0.375 ; IIV V1

$SIGMA    ; residual variability
0.289     ; EPS(1), proportional
1E-13 FIX ; EPS(2); additive, required by M7+ censoring method

$EST
METHOD=1 INTERACTION; FOCE-I
MAXEVAL=9999
SIG=3
PRINT=5

$COVARIANCE PRINT=E UNCONDITIONAL MATRIX=S

$TABLE ; output table for standard outcomes
ID TIME TAD DV cAUC EVID PRED IPRED WRES IWRES RES IRES CWRES CRES NOPRINT
ONEHEADER FILE=run12_sdtab

$TABLE ; output table for parameters and covariates
ID cAUC CL V1 V2 Q K10 K12 K21 ADA SEX COL BW ALB AGE CREAT NOPRINT NOAPPEND
ONEHEADER FILE=run12_pa_cov
```

## A3. Exploratory Data Anslysis {.unnumbered .unlisted}
```{r conc_time profile}
#| echo: false
data <- data %>%
  arrange(ID, TIME) %>%
  group_by(ID) %>%
  mutate(
    last_dose_time = cummax(if_else(EVID == 1, TIME, -Inf)),
    last_dose_time = if_else(is.finite(last_dose_time),
                             last_dose_time, NA_real_),
    TAD = TIME - last_dose_time
  ) %>%
  ungroup()


ggplot(data %>% filter(CONC_M7!=0),
       aes(y = CONC_M7,
           x  = TAD)) +
  geom_point(color = "blue", size = 0.1)+
  stat_summary_bin(bins = 13,
                   fun.y = mean,
                   geom = "line",
                   linetype = "dashed") +
  stat_summary_bin(bins = 13,
                   fun.y = median,
                   geom = "line") +
  scale_y_log10()+
  labs(x = "Time After Dose (days)",
       y = "Plasma Concentration (mg/L)",
       title = "Concentration-Time Profile of PMX001") +
  theme_minimal()
```

```{r}
#| echo: false
h1 <- ggplot(data, aes(x = AGE)) +
  geom_histogram(color = "black", fill = "white", binwidth = 3) +
  theme_minimal()
h2 <- ggplot(data, aes(x = ALB)) +
  geom_histogram(color = "black", fill = "white", binwidth = 1.8) +
  theme_minimal()
h3 <- ggplot(data, aes(x = BW)) +
  geom_histogram(color = "black", fill = "white", binwidth = 3) +
  theme_minimal()
h4 <- ggplot(data, aes(x = CREAT)) +
  geom_histogram(color = "black", fill = "white", binwidth = 0.12) +
  theme_minimal()
h1 + h2 + h3 + h4 +
  plot_annotation(title = "Histograms of Continuous Covariates")
```

## A4. Exposure-Response Quartile Quartile Plot

```{r}
#| echo: false
dat3 <- read.table(file = "run16_pa_cov", skip = 1, header = TRUE)
dat3 <- dat3 %>%
  mutate(COL = as.integer(as.character(COL))) %>%
  group_by(ID) %>%
  mutate(had_one = any(COL == 1, na.rm = TRUE),
    COL = if_else(had_one & (is.na(COL) | COL == 0L), 1L, 0L)) %>%
  select(-had_one) %>%
  ungroup()

dat3 <- dat3 %>% mutate(COL = as.numeric(COL))

dat3 <- dat3 %>%
  mutate(
    cAUC = suppressWarnings(as.numeric(cAUC)),
    COL = factor(COL, levels = c(0, 1),
                 labels = c("No Colectomy", "Colectomy")),
    quantile = cut(cAUC,
                   breaks = seq(min(cAUC, na.rm = TRUE),
                                max(cAUC, na.rm = TRUE),
                                length.out = 5), # 4 bins → 5 break points
))

# --- 3) Quick summary by group ---
summary_tbl <- dat3 %>%
  group_by(COL) %>%
  summarise(n = n(),
            median_cAUC = median(cAUC),
            IQR_cAUC = IQR(cAUC),
            mean_cAUC = mean(cAUC),
            sd_cAUC = sd(cAUC),
            .groups = "drop")

print(summary_tbl)

# --- 4) Logistic regression: probability of Colectomy ~ cAUC ---
# Use numeric 0/1 as response for clarity
logit_model <- glm(COL ~ cAUC, data = dat3, family = binomial)

# Prediction grid across cAUC range
curve_df <- data.frame(cAUC = seq(min(dat3$cAUC), max(dat3$cAUC),
                                  length.out = 100))
curve_df$pred_prob <- predict(logit_model, newdata = curve_df,
                              type = "response")

summary_df <- dat3 %>%
  filter(!is.na(quantile)) %>%
  group_by(quantile) %>%
  summarise(cAUC_min = min(cAUC),
            cAUC_max = max(cAUC),
            prob_col = mean(COL == "Colectomy"),
            .groups = "drop") %>%
  mutate(
    perc_label = percent(prob_col, accuracy = 1),            
    x_mid = (cAUC_min + cAUC_max) / 2,
    y_label = pmax(prob_col * 0.5, 0.07))

rect_df <- bind_rows(
  summary_df %>%
    transmute(quantile, cAUC_min, cAUC_max, ymin = 0, ymax = 1,
              type = "No colectomy"),
  summary_df %>%
    transmute(quantile, cAUC_min, cAUC_max, ymin = 0, ymax = prob_col,
              type = "Colectomy"))

ggplot(rect_df) +
  geom_rect(aes(xmin = cAUC_min, xmax = cAUC_max,
                ymin = ymin, ymax = ymax, fill = type),
            color = "black", size = 0.3, alpha = 0.8) +
  geom_text(data = summary_df,
            aes(x = x_mid, y = y_label, label = perc_label),
            color = "black", fontface = "bold", size = 4) +
  geom_line(data = curve_df,
            aes(x = cAUC, y = pred_prob),
            color = "#00244D", size = 1) +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, 1)) +
  scale_fill_manual(
    name = "Status",
    values = c("No colectomy" = "#C7E3FF", "Colectomy" = "#3C87C9")
  ) +
  labs(
    x = "AUC (from Time = 0 to last) (mg·day/L)",
    y = "Probability of Colectomy",
    title = "Quartile Plot of AUC with Colectomy Probability"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

ggsave("QQplot.png", width = 5, height = 4.0, dpi = 300)
```

```{r}
#| echo: false
# --- 1) Read and normalize COL at subject level (unchanged logic) ---
pacov <- read.table(file = "run16_pa_cov", skip = 1, header = TRUE)
sdtab <- read.table(file = "run16_sdtab", skip = 1, header = TRUE)
# ---- 2) Keep only what we need from sdtab (ID and TIME), and create an obs index per ID ----
sdtab_idx <- sdtab %>%
  select(ID, TIME) %>%           # sdtab has TIME; keep it for merging
  group_by(ID) %>%
  mutate(obs = row_number()) %>% # per-ID row index
  ungroup()

# ---- 3) Create the same obs index on pa_cov (to align rows within each ID) ----
pacov_idx <- pacov %>%
  group_by(ID) %>%
  mutate(obs = row_number()) %>%
  ungroup()

# ---- 4) Join pa_cov with TIME by (ID, obs) ----
pacov_with_time <- pacov_idx %>%
  left_join(sdtab_idx, by = c("ID", "obs")) %>%
  select(-obs)  # drop the temporary index

dat3 <- as.data.frame(pacov_with_time)
dat3 <- dat3 %>%  mutate(time = as.numeric(TIME),
                         group = case_when(
                           ALB < median(ALB) ~ "Below Median",
                           ALB >= median(ALB) ~ "Above Median"))
```

```{r}
#| include: false
fit <- survfit(Surv(time = time, event = COL) ~ group, data = dat3)
ggsurvplot(fit,
           conf.int = TRUE,
           pval = FALSE,
           xlab = "Time",
           ylab = "Survival Probability",
           title = "Kaplan-Meier Curve for Colectomy")
```

```{r}
#| include: false
# --- 1) Read and normalize COL at subject level (unchanged logic) ---
pacov <- read.table(file = "run16_pa_cov", skip = 1, header = TRUE)
sdtab <- read.table(file = "run16_sdtab", skip = 1, header = TRUE)
# ---- 2) Keep only what we need from sdtab (ID and TIME), and create an obs index per ID ----
sdtab_idx <- sdtab %>%
  select(ID, TIME) %>%           # sdtab has TIME; keep it for merging
  group_by(ID) %>%
  mutate(obs = row_number()) %>% # per-ID row index
  ungroup()

# ---- 3) Create the same obs index on pa_cov (to align rows within each ID) ----
pacov_idx <- pacov %>%
  group_by(ID) %>%
  mutate(obs = row_number()) %>%
  ungroup()

# ---- 4) Join pa_cov with TIME by (ID, obs) ----
pacov_with_time <- pacov_idx %>%
  left_join(sdtab_idx, by = c("ID", "obs")) %>%
  select(-obs)  # drop the temporary index

dat3 <- pacov_with_time
dat3 <- dat3 %>%
  mutate(COL = as.integer(as.character(COL))) %>%
  group_by(ID) %>%
  mutate(had_one = any(COL == 1, na.rm = TRUE),
    COL = if_else(had_one & (is.na(COL) | COL == 0L), 1L, 0L)) %>%
  select(-had_one) %>%
  ungroup()

dat3 <- dat3 %>% mutate(COL = as.numeric(COL))

dat3 <- dat3 %>%
  mutate(cAUC_num = suppressWarnings(as.numeric(cAUC))) %>%
  group_by(ID) %>%
  arrange(TIME, .by_group = TRUE) %>%
  summarise(
    AUC0_tlast = max(cAUC_num, na.rm = TRUE),  # final cumulative AUC
    tlast      = max(TIME, na.rm = TRUE),
    .groups    = "drop"
  ) %>%
  right_join(dat3, by = "ID")  # bring AUC0_tlast back to the full dataset

dat3 <- dat3 %>%
  mutate(
    AUC0_tlast = suppressWarnings(as.numeric(AUC0_tlast)),
    COL = factor(COL, levels = c(0, 1),
                 labels = c("No Colectomy", "Colectomy")),
    quantile = cut(AUC0_tlast,
                   breaks = seq(min(AUC0_tlast, na.rm = TRUE),
                                max(AUC0_tlast, na.rm = TRUE),
                                length.out = 5) # 4 bins → 5 break points
))

# --- 3) Quick summary by group ---
summary_tbl <- dat3 %>%
  group_by(COL) %>%
  summarise(n = n(),
            median_AUC0_tlast = median(AUC0_tlast),
            IQR_AUC0_tlast = IQR(AUC0_tlast),
            mean_AUC0_tlast = mean(AUC0_tlast),
            sd_AUC0_tlast = sd(AUC0_tlast),
            .groups = "drop")

print(summary_tbl)

# --- 4) Logistic regression: probability of Colectomy ~ AUC0_tlast ---
# Use numeric 0/1 as response for clarity
logit_model <- glm(COL ~ AUC0_tlast, data = dat3, family = binomial)

# Prediction grid across AUC0_tlast range
curve_df <- data.frame(AUC0_tlast = seq(min(dat3$AUC0_tlast), max(dat3$AUC0_tlast),
                                  length.out = 100))
curve_df$pred_prob <- predict(logit_model, newdata = curve_df,
                              type = "response")

summary_df <- dat3 %>%
  filter(!is.na(quantile)) %>%
  group_by(quantile) %>%
  summarise(AUC0_tlast_min = min(AUC0_tlast),
            AUC0_tlast_max = max(AUC0_tlast),
            prob_col = mean(COL == "Colectomy"),
            .groups = "drop") %>%
  mutate(
    perc_label = percent(prob_col, accuracy = 1),            
    x_mid = (AUC0_tlast_min + AUC0_tlast_max) / 2,
    y_label = pmax(prob_col * 0.5, 0.07))

rect_df <- bind_rows(
  summary_df %>%
    transmute(quantile, AUC0_tlast_min, AUC0_tlast_max, ymin = 0, ymax = 1,
              type = "No colectomy"),
  summary_df %>%
    transmute(quantile, AUC0_tlast_min, AUC0_tlast_max, ymin = 0, ymax = prob_col,
              type = "Colectomy"))

ggplot(rect_df) +
  geom_rect(aes(xmin = AUC0_tlast_min, xmax = AUC0_tlast_max,
                ymin = ymin, ymax = ymax, fill = type),
            color = "black", size = 0.3, alpha = 0.8) +
  geom_text(data = summary_df,
            aes(x = x_mid, y = y_label, label = perc_label),
            color = "black", fontface = "bold", size = 4) +
  geom_line(data = curve_df,
            aes(x = AUC0_tlast, y = pred_prob),
            color = "#00244D", size = 1) +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, 1)) +
  scale_fill_manual(
    name = "Status",
    values = c("No colectomy" = "#C7E3FF", "Colectomy" = "#3C87C9")
  ) +
  labs(
    x = "AUC (from Time = 0 to last) (mg·day/L)",
    y = "Probability of Colectomy",
    title = "Quartile Plot of AUC with Colectomy Probability"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

ggsave("QQplot.png", width = 5, height = 4.0, dpi = 300)
```

```{r}
library(dplyr)
library(ggplot2)
library(scales)
library(tidyr)

# --- define shared breaks (4 bins -> 5 break points) ---
brks <- seq(min(dat3$AUC0_tlast, na.rm = TRUE),
            max(dat3$AUC0_tlast, na.rm = TRUE),
            length.out = 5)

dat3 <- dat3 %>%
  mutate(
    # factor by the shared breaks (include lowest to avoid NA for min)
    quantile = cut(AUC0_tlast, breaks = brks, right = TRUE, include.lowest = TRUE)
  )

# --- summary per bin, with exact min/max taken from the shared breaks ---
summary_df <- dat3 %>%
  filter(!is.na(quantile)) %>%
  group_by(quantile) %>%
  summarise(
    AUC0_tlast_min = min(AUC0_tlast, na.rm = TRUE),
    AUC0_tlast_max = max(AUC0_tlast, na.rm = TRUE),
    prob_col = mean(COL == "Colectomy", na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # Replace the computed min/max with the exact interval bounds from `brks`
  # so adjacent bins share boundaries perfectly.
  # We can do this by mapping factor levels back to brks:
  mutate(bin_id = as.integer(quantile)) %>%
  mutate(
    AUC0_tlast_min = brks[bin_id],
    AUC0_tlast_max = brks[bin_id + 1],
    perc_label = percent(prob_col, accuracy = 1),
    x_mid = (AUC0_tlast_min + AUC0_tlast_max) / 2,
    y_label = pmax(prob_col * 0.5, 0.07)
  )

rect_df <- bind_rows(
  summary_df %>%
    transmute(quantile, AUC0_tlast_min, AUC0_tlast_max, ymin = 0, ymax = 1,
              type = "No colectomy"),
  summary_df %>%
    transmute(quantile, AUC0_tlast_min, AUC0_tlast_max, ymin = 0, ymax = prob_col,
              type = "Colectomy")
)

# prediction curve (unchanged)
curve_df <- data.frame(
  AUC0_tlast = seq(min(dat3$AUC0_tlast, na.rm = TRUE),
                   max(dat3$AUC0_tlast, na.rm = TRUE),
                   length.out = 100)
)
logit_model <- glm(COL ~ AUC0_tlast, data = dat3, family = binomial)
curve_df$pred_prob <- predict(logit_model, newdata = curve_df, type = "response")

ggplot(rect_df) +
  geom_rect(aes(xmin = AUC0_tlast_min, xmax = AUC0_tlast_max,
                ymin = ymin, ymax = ymax, fill = type),
            # remove borders so adjacent bins visually connect
            color = NA, size = 0, alpha = 0.85) +
  geom_text(data = summary_df,
            aes(x = x_mid, y = y_label, label = perc_label),
            color = "black", fontface = "bold", size = 4) +
  geom_line(data = curve_df,
            aes(x = AUC0_tlast, y = pred_prob),
            color = "#00244D", size = 1) +
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, 1),
                     expand = expansion(mult = 0)) +   # no vertical padding (optional)
  scale_x_continuous(expand = expansion(mult = 0)) +    # no horizontal padding -> bins flush
  scale_fill_manual(
    name = "Status",
    values = c("No colectomy" = "#C7E3FF", "Colectomy" = "#3C87C9")
  ) +
  labs(
    x = "AUC (from Time = 0 to last) (mg·day/L)",
    y = "Probability of Colectomy",
    title = "Quartile Plot of AUC with Colectomy Probability"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
ggsave("QQcorr.png", width = 5, height = 4, units = "in")
```

## A5. Goodness of Fit Plots

```{r}
#| echo: false
dat <- read.table (file='run12_sdtab', skip=1, header=T)
dat2 <- read.table (file='run16_sdtab', skip=1, header=T)
```

```{r}
#| echo: false
p1 <- ggplot(dat %>% filter(CONC_M7 != 0)) +
  geom_point (aes(x=PRED, y=CONC_M7),  colour='darkblue', size = 0.4) +
  geom_abline(aes(slope=1, intercept=0), linetype='dashed') +
  labs(title = "Linear Elimination",
       y = "Observed Concentration",
       x = "Predicted Concentration") +
  xlim(0, 200) +
  theme_minimal()
p2 <- ggplot(dat2 %>% filter(CONC_M7 != 0)) +
  geom_point (aes(x=PRED, y=CONC_M7),  colour='darkblue', size = 0.4) +
  geom_abline(aes(slope=1, intercept=0), linetype='dashed') +
  labs(title = "TMDD (MM Approximation)",
       y = "Observed Concentration",
       x = "Predicted Concentration") +
  xlim(0,200) +
  theme_minimal()
p1_2 <- p1+p2 + patchwork::plot_annotation(title = "Population Predicted versus Observed Concentrations in Two-Compartment Models")

ggsave("PRED_OBS.png", plot = p1_2, width = 8, height = 5, units = "in")

p1_2
```

```{r}
#| echo: false
p11 <- ggplot(dat %>% filter(CONC_M7 != 0)) +
  geom_point (aes(x=log10(PRED), y=log10(CONC_M7)),  colour='darkblue', size = 0.4) +
  geom_abline(aes(slope=1, intercept=0), linetype='dashed') +
  labs(title = "Linear Elimination",
       y = "Observed Concentration",
       x = "Predicted Concentration") +
  theme_minimal()
p12 <- ggplot(dat2 %>% filter(CONC_M7 != 0)) +
  geom_point (aes(x=log10(PRED), y=log10(CONC_M7)),  colour='darkblue', size = 0.4) +
  geom_abline(aes(slope=1, intercept=0), linetype='dashed') +
  labs(title = "TMDD (MM Approximation)",
       y = "Observed Concentration",
       x = "Predicted Concentration") +
  theme_minimal()
p11_12 <- p11 + p12 + patchwork::plot_annotation(title = "Log-Scaled Population Predicted versus Observed Concentrations in Two-Compartment Models")

ggsave("PRED_OBS_log.png", plot = p11_12, width = 9, height = 5, units = "in")

p11_12
```

```{r}
#| echo: false
p3 <- ggplot(dat) + # CWRES used because of FOCE-I
  geom_point (aes(x=PRED, y=CWRES),  colour='darkblue', size = 0.4) +
  geom_abline(aes(slope=0, intercept=0), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=3), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=-3), linetype='dashed') +
  labs(title = "Linear Elimination",
       y = "Condtional Weighed Residuals",
       x = "Predicted Concentration") +
  xlim(0,300)+
  ylim(-4,7) + 
  theme_minimal()
p4 <- ggplot(dat2) + # CWRES used because of FOCE-I
  geom_point (aes(x=PRED, y=CWRES),  colour='darkblue', size = 0.4) +
  geom_abline(aes(slope=0, intercept=0), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=3), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=-3), linetype='dashed') +
  labs(title = "TMDD (MM Approximation)",
       y = "Condtional Weighed Residuals",
       x = "Predicted Concentration") +
  xlim(0,300)+
  ylim(-4,7) + 
  theme_minimal()
p3_4 <- p3 + p4 + patchwork::plot_annotation(title = "Conditional Weighed Residuals versus Population Predicted Concentrations in Two-Compartment Models")
ggsave("PRED_CWRES_PRED.png", plot = p3_4, width = 9.3, height = 5, units = "in")

p3_4
```

```{r}
#| echo: false
p5 <- ggplot(dat) +
  geom_point (aes(x=PRED, y=RES),  colour='darkblue', size = 0.4) +
  geom_abline(aes(slope=0, intercept=0), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=3), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=-3), linetype='dashed') +
  labs(title = "Linear Elimination",
       y = "Population Residuals",
       x = "Predicted Concentration") +
    xlim(0,300) +
  ylim(-200,400) +
  theme_minimal()
p6 <- ggplot(dat2) +
  geom_point (aes(x=PRED, y=RES),  colour='darkblue', size = 0.4) +
  geom_abline(aes(slope=0, intercept=0), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=3), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=-3), linetype='dashed') +
  labs(title = "TMDD (MM Approximation)",
       y = "Population Residuals",
       x = "Predicted Concentration") +
  xlim(0,300) +
  ylim(-200,400) +
  theme_minimal()
p5_6 <- p5+p6 + patchwork::plot_annotation(title = "Population Residuals versus Population Predicted Concentrations in Two-Compartment Models")
ggsave("PRED_RES_PRED.png", plot = p5_6, width = 9.3, height = 5, units = "in")

p5_6
```

```{r}
#| echo: false
p7 <- ggplot(dat) + # CRES used because of FOCE-I
  geom_point (aes(x=PRED, y=CRES),  colour='darkblue', size = 0.4) +
  geom_abline(aes(slope=0, intercept=0), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=3), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=-3), linetype='dashed') +
  labs(title = "Linear Elimination",
       y = "Conditional Population Residuals",
       x = "Predicted Concentration") +
    xlim(0,200) + 
  ylim(-100,500) +
  theme_minimal()
p8 <- ggplot(dat2) + # CRES used because of FOCE-I
  geom_point (aes(x=PRED, y=CRES),  colour='darkblue', size = 0.4) +
  geom_abline(aes(slope=0, intercept=0), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=3), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=-3), linetype='dashed') +
  labs(title = "TMDD (MM Approximation)",
       y = "Conditional Population Residuals",
       x = "Predicted Concentration") +
  xlim(0,200) + 
  ylim(-100,500) +
  theme_minimal()
p7_8 <- p7+p8 + patchwork::plot_annotation(title = "Conditional Population Residuals versus Population Predicted Concentrations in Two-Compartment Models")
ggsave("PRED_CRES_PRED.png", plot = p7_8, width = 9.6, height = 5, units = "in")

p7_8
```

```{r}
#| echo: false
p9 <- ggplot(dat %>% filter(CWRES != 0)) + # CWRES used because of FOCE-I
  geom_point (aes(x=TAD, y=CWRES),  colour='darkblue', size = 0.4) +
  geom_abline(aes(slope=0, intercept=0), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=3), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=-3), linetype='dashed') +
  labs(title = "Linear Elimination",
       y = "Conditional Weighed Residuals",
       x = "Time After Dose (days)") +
    ylim(-3,5) +
  theme_minimal()
p10 <- ggplot(dat2 %>% filter(CWRES != 0)) + # CWRES used because of FOCE-I
  geom_point (aes(x=TAD, y=CWRES),  colour='darkblue', size = 0.4) +
  geom_abline(aes(slope=0, intercept=0), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=3), linetype='dashed') +
  geom_abline(aes(slope=0, intercept=-3), linetype='dashed') +
  labs(title = "TMDD (MM Approximation)",
       y = "Conditional Weighed Residuals",
       x = "Time After Dose (days)") +
  ylim(-3,5) +
  theme_minimal()
p9_10 <- p9 + p10 + patchwork::plot_annotation(title = "Conditional Weighed Residuals versus Time After Dose in Two-Compartment Models")
ggsave("PRED_CWRES_TAD.png", plot = p9_10, width = 8, height = 5, units = "in")

p9_10
```