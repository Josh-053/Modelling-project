}
model_dir <- dirname(model_path)
old_wd <- getwd()
setwd(model_dir)
capture.output(
xpdb <- xpose4::xpose.data(model_runno)
)
setwd(old_wd)
lst_basename <- paste0("run06.lst")
lst_path <- file.path(results.directory, lst_basename)
# Sanity check
if (is.null(xpdb) || !inherits(xpdb, "xpose.data")) {
stop("xpdb could not be created. Check that NONMEM output files (.lst, .ext, .cov, etc.) exist in the model directory.")
}
model_suffix <- paste0('.', tools::file_ext(model_path))
xpdb <- xpose4::xpose.data(xpose_runno,
directory=results.directory,
tab.suffix=tab.suffix,
mod.prefix=PsNR::model_prefix(meta),
mod.suffix=model_suffix)
#uncomment below to change the idv from TIME to something else such as TAD.
#Other xpose preferences could also be changed
#xpdb@Prefs@Xvardef$idv="TAD"
xpose4::runsum(xpdb,
dir=results.directory,
modfile=PsNR::model_path(meta),
listfile=file.path(results.directory,
sub(model_suffix,
".lst",
basename(PsNR::model_path(meta)))))
#START OF AUTO-GENERATED PREAMBLE, WILL BE OVERWRITTEN WHEN THIS FILE IS USED AS A TEMPLATE
#Created 2026-01-02 at 18:49
xpose.runno <- '06.mod'
toolname <- 'execute'
pdf.filename <- paste0('PsN_',toolname,'_plots.pdf')
working.directory<-'/home/ali/Documents/GitHub/Modelling-project/modelfit_dir1/'
results.directory <- '..'
subset.variable<-NULL
tab.suffix <- ''
rscripts.directory <- '/usr/local/share/perl5/5.40/PsN_5_6_0/R-scripts' # This is not used
raw.results.file <- 'raw_results_run06.csv'
theta.labels <- c('[1]   TVCL (L/h)','[2,3] TVV1 (L)','V2','Q','CLADA')
theta.fixed <- c(FALSE,FALSE,FALSE,FALSE,FALSE)
omega.labels <- c('IIV CL','IIV V')
omega.fixed <- c(FALSE,FALSE)
sigma.labels <- c('EPS(1), proportional','EPS(2)')
sigma.fixed <- c(FALSE,TRUE)
n.eta <- 2
n.eps <- 2
res.table <- 'run06'
setwd(working.directory)
############################################################################
#END OF AUTO-GENERATED PREAMBLE
#WHEN THIS FILE IS USED AS A TEMPLATE THIS LINE MUST LOOK EXACTLY LIKE THIS
# get libPaths
library(PsNR)
library(magrittr)
library(methods)
library(xpose4)
#add R_info to the meta file
R_info(directory=working.directory)
meta <- PsNR::metadata(working.directory)
model_path <- PsNR::model_path(meta)
model_runno <- PsNR::model_runno(meta)
xpose_runno <- xpose.runno
model_dir <- dirname(model_path)
old_wd <- getwd()
setwd(model_dir)
capture.output(
xpdb <- xpose4::xpose.data(model_runno)
)
setwd(old_wd)
lst_basename <- paste0("run06.lst")
lst_path <- file.path(results.directory, lst_basename)
# Sanity check
if (is.null(xpdb) || !inherits(xpdb, "xpose.data")) {
stop("xpdb could not be created. Check that NONMEM output files (.lst, .ext, .cov, etc.) exist in the model directory.")
}
# get libPaths
library(PsNR)
library(magrittr)
library(methods)
library(xpose4)
library(tools)
#add R_info to the meta file
R_info(directory=working.directory)
meta <- PsNR::metadata(working.directory)
model_path <- PsNR::model_path(meta)
model_runno <- PsNR::model_runno(meta)
xpose_runno <- xpose.runno
model_dir <- dirname(model_path)
old_wd <- getwd()
setwd(model_dir)
capture.output(
xpdb <- xpose4::xpose.data(model_runno)
)
setwd(old_wd)
lst_basename <- paste0("run06.lst")
lst_path <- file.path(results.directory, lst_basename)
# Sanity check
if (is.null(xpdb) || !inherits(xpdb, "xpose.data")) {
stop("xpdb could not be created. Check that NONMEM output files (.lst, .ext, .cov, etc.) exist in the model directory.")
}
#START OF AUTO-GENERATED PREAMBLE, WILL BE OVERWRITTEN WHEN THIS FILE IS USED AS A TEMPLATE
#Created 2026-01-02 at 18:49
xpose.runno <- '06.mod'
toolname <- 'execute'
pdf.filename <- paste0('PsN_',toolname,'_plots.pdf')
working.directory<-'/home/ali/Documents/GitHub/Modelling-project/modelfit_dir1/'
results.directory <- '..'
subset.variable<-NULL
tab.suffix <- ''
rscripts.directory <- '/usr/local/share/perl5/5.40/PsN_5_6_0/R-scripts' # This is not used
raw.results.file <- 'raw_results_run06.csv'
theta.labels <- c('[1]   TVCL (L/h)','[2,3] TVV1 (L)','V2','Q','CLADA')
theta.fixed <- c(FALSE,FALSE,FALSE,FALSE,FALSE)
omega.labels <- c('IIV CL','IIV V')
omega.fixed <- c(FALSE,FALSE)
sigma.labels <- c('EPS(1), proportional','EPS(2)')
sigma.fixed <- c(FALSE,TRUE)
n.eta <- 2
n.eps <- 2
res.table <- 'run06'
setwd(working.directory)
############################################################################
#END OF AUTO-GENERATED PREAMBLE
#WHEN THIS FILE IS USED AS A TEMPLATE THIS LINE MUST LOOK EXACTLY LIKE THIS
# get libPaths
library(PsNR)
library(magrittr)
library(methods)
library(xpose4)
#add R_info to the meta file
R_info(directory=working.directory)
meta <- PsNR::metadata(working.directory)
model_path <- PsNR::model_path(meta)
xpose_runno <- xpose.runno
model_suffix <- paste0('.', tools::file_ext(model_path))
xpdb <- xpose4::xpose.data(xpose_runno, directory=results.directory, tab.suffix=tab.suffix, mod.prefix=PsNR::model_prefix(meta), mod.suffix=model_suffix)
#uncomment below to change the idv from TIME to something else such as TAD.
#Other xpose preferences could also be changed
#xpdb@Prefs@Xvardef$idv="TAD"
xpose4::runsum(xpdb, dir=results.directory,
modfile=PsNR::model_path(meta),
listfile=file.path(results.directory, sub(model_suffix, ".lst", basename(PsNR::model_path(meta)))))
if (is.tte) {
#data is in the model directory, go there to read input
setwd(dirname(PsNR::model_path(meta)))
capture.output(xpdb <- xpose4::xpose.data(PsNR::model_runno(meta)))
plots <- xpose4::kaplan.plot(object=xpdb, VPC=T)
#go back to vpc directory
setwd(working.directory)
} else if (is.categorical) {
plots <- xpose4::xpose.VPC.categorical(vpc.info=tool.results.file, vpctab=vpctab)
} else if (have.loq.data | have.censored) {
plots <- xpose4::xpose.VPC.both(vpc.info=tool.results.file, vpctab=vpctab, logy = TRUE)
} else {
plots <- xpose4::xpose.VPC(vpc.info=tool.results.file, vpctab=vpctab)
}
gc()
#START OF AUTO-GENERATED PREAMBLE, WILL BE OVERWRITTEN WHEN THIS FILE IS USED AS A TEMPLATE
#Created 2026-01-02 at 18:36
xpose.runno <- '06.mod'
toolname <- 'vpc'
pdf.filename <- paste0('PsN_',toolname,'_plots.pdf')
working.directory<-'/home/ali/Documents/GitHub/Modelling-project/vpc_run06_lloq_flag/'
results.directory <- '..'
subset.variable<-NULL
tab.suffix <- ''
rscripts.directory <- '/usr/local/share/perl5/5.40/PsN_5_6_0/R-scripts' # This is not used
tool.results.file <- 'vpc_results.csv'
theta.labels <- c('[1]   TVCL (L/h)','[2,3] TVV1 (L)','V2','Q','CLADA')
theta.fixed <- c(FALSE,FALSE,FALSE,FALSE,FALSE)
omega.labels <- c('IIV CL','IIV V')
omega.fixed <- c(FALSE,FALSE)
sigma.labels <- c('EPS(1), proportional','EPS(2)')
sigma.fixed <- c(FALSE,TRUE)
n.eta <- 2
n.eps <- 2
vpctab <- 'vpctab06'
have.loq.data <- TRUE
have.censored <- TRUE
is.categorical <- FALSE
is.tte <- FALSE
dv <- 'CONC'
idv <- 'TAD'
samples <- 200
setwd(working.directory)
############################################################################
#END OF AUTO-GENERATED PREAMBLE
#WHEN THIS FILE IS USED AS A TEMPLATE THIS LINE MUST LOOK EXACTLY LIKE THIS
# get libPaths
library(PsNR)
library(magrittr)
library(methods)
library(xpose4)
library(vpc)
library(ggplot2)
#add R_info to the meta file
R_info(directory=working.directory)
meta <- PsNR::metadata(working.directory)
if (is.tte) {
#data is in the model directory, go there to read input
setwd(dirname(PsNR::model_path(meta)))
capture.output(xpdb <- xpose4::xpose.data(PsNR::model_runno(meta)))
plots <- xpose4::kaplan.plot(object=xpdb, VPC=T)
#go back to vpc directory
setwd(working.directory)
} else if (is.categorical) {
plots <- xpose4::xpose.VPC.categorical(vpc.info=tool.results.file, vpctab=vpctab)
} else if (have.loq.data | have.censored) {
plots <- xpose4::xpose.VPC.both(vpc.info=tool.results.file, vpctab=vpctab, logy = TRUE)
} else {
plots <- xpose4::xpose.VPC(vpc.info=tool.results.file, vpctab=vpctab)
}
#START OF AUTO-GENERATED PREAMBLE, WILL BE OVERWRITTEN WHEN THIS FILE IS USED AS A TEMPLATE
#Created 2026-01-02 at 18:36
xpose.runno <- '06.mod'
toolname <- 'vpc'
pdf.filename <- paste0('PsN_',toolname,'_plots.pdf')
working.directory<-'/home/ali/Documents/GitHub/Modelling-project/vpc_run06_lloq_flag/'
results.directory <- '..'
subset.variable<-NULL
tab.suffix <- ''
rscripts.directory <- '/usr/local/share/perl5/5.40/PsN_5_6_0/R-scripts' # This is not used
tool.results.file <- 'vpc_results.csv'
theta.labels <- c('[1]   TVCL (L/h)','[2,3] TVV1 (L)','V2','Q','CLADA')
theta.fixed <- c(FALSE,FALSE,FALSE,FALSE,FALSE)
omega.labels <- c('IIV CL','IIV V')
omega.fixed <- c(FALSE,FALSE)
sigma.labels <- c('EPS(1), proportional','EPS(2)')
sigma.fixed <- c(FALSE,TRUE)
n.eta <- 2
n.eps <- 2
vpctab <- 'vpctab06'
have.loq.data <- TRUE
have.censored <- TRUE
is.categorical <- FALSE
is.tte <- FALSE
dv <- 'CONC'
idv <- 'TAD'
samples <- 200
setwd(working.directory)
############################################################################
#END OF AUTO-GENERATED PREAMBLE
#WHEN THIS FILE IS USED AS A TEMPLATE THIS LINE MUST LOOK EXACTLY LIKE THIS
# get libPaths
library(PsNR)
library(magrittr)
library(methods)
library(xpose4)
library(vpc)
library(ggplot2)
#add R_info to the meta file
R_info(directory=working.directory)
meta <- PsNR::metadata(working.directory)
if (is.tte) {
#data is in the model directory, go there to read input
setwd(dirname(PsNR::model_path(meta)))
capture.output(xpdb <- xpose4::xpose.data(PsNR::model_runno(meta)))
plots <- xpose4::kaplan.plot(object=xpdb, VPC=T)
#go back to vpc directory
setwd(working.directory)
} else if (is.categorical) {
plots <- xpose4::xpose.VPC.categorical(vpc.info=tool.results.file, vpctab=vpctab)
} else if (have.loq.data | have.censored) {
plots <- xpose4::xpose.VPC.both(vpc.info=tool.results.file, vpctab=vpctab, logy = TRUE)
} else {
plots <- xpose4::xpose.VPC(vpc.info=tool.results.file, vpctab=vpctab)
}
if (is.tte) {
#data is in the model directory, go there to read input
setwd(dirname(PsNR::model_path(meta)))
capture.output(xpdb <- xpose4::xpose.data(PsNR::model_runno(meta)))
plots <- xpose4::kaplan.plot(object=xpdb, VPC=T)
#go back to vpc directory
setwd(working.directory)
} else if (is.categorical) {
plots <- xpose4::xpose.VPC.categorical(vpc.info=tool.results.file, vpctab=vpctab)
} else if (have.loq.data | have.censored) {
plots <- xpose4::xpose.VPC.both(logy = TRUE, vpc.info=tool.results.file, vpctab=vpctab)
} else {
plots <- xpose4::xpose.VPC(vpc.info=tool.results.file, vpctab=vpctab)
}
if (is.tte) {
#data is in the model directory, go there to read input
setwd(dirname(PsNR::model_path(meta)))
capture.output(xpdb <- xpose4::xpose.data(PsNR::model_runno(meta)))
plots <- xpose4::kaplan.plot(object=xpdb, VPC=T)
#go back to vpc directory
setwd(working.directory)
} else if (is.categorical) {
plots <- xpose4::xpose.VPC.categorical(vpc.info=tool.results.file, vpctab=vpctab)
} else if (have.loq.data | have.censored) {
plots <- xpose4::xpose.VPC.both(cont.logy = TRUE, vpc.info=tool.results.file, vpctab=vpctab)
} else {
plots <- xpose4::xpose.VPC(vpc.info=tool.results.file, vpctab=vpctab)
}
print(plots)
if (is.tte) {
#data is in the model directory, go there to read input
setwd(dirname(PsNR::model_path(meta)))
capture.output(xpdb <- xpose4::xpose.data(PsNR::model_runno(meta)))
plots <- xpose4::kaplan.plot(object=xpdb, VPC=T)
#go back to vpc directory
setwd(working.directory)
} else if (is.categorical) {
plots <- xpose4::xpose.VPC.categorical(vpc.info=tool.results.file, vpctab=vpctab)
} else if (have.loq.data | have.censored) {
plots <- xpose4::xpose.VPC.both(cont.logy = TRUE, vpc.info=tool.results.file, vpctab=vpctab)
} else {
plots <- xpose4::xpose.VPC(logy = TRUE, vpc.info=tool.results.file, vpctab=vpctab)
}
print(plots)
if (is.tte) {
#data is in the model directory, go there to read input
setwd(dirname(PsNR::model_path(meta)))
capture.output(xpdb <- xpose4::xpose.data(PsNR::model_runno(meta)))
plots <- xpose4::kaplan.plot(object=xpdb, VPC=T)
#go back to vpc directory
setwd(working.directory)
} else if (is.categorical) {
plots <- xpose4::xpose.VPC.categorical(vpc.info=tool.results.file, vpctab=vpctab)
} else if (have.loq.data | have.censored) {
plots <- xpose4::xpose.VPC.both(lower.limit = 0.000000001, cont.logy = TRUE, vpc.info=tool.results.file, vpctab=vpctab)
} else {
plots <- xpose4::xpose.VPC(logy = TRUE, vpc.info=tool.results.file, vpctab=vpctab)
}
print(plots)
#START OF AUTO-GENERATED PREAMBLE, WILL BE OVERWRITTEN WHEN THIS FILE IS USED AS A TEMPLATE
#Created 2026-01-02 at 19:34
xpose.runno <- '06.mod'
toolname <- 'vpc'
pdf.filename <- paste0('PsN_',toolname,'_plots.pdf')
working.directory<-'/home/ali/Documents/GitHub/Modelling-project/vpc_run06_lloq_predcorr/'
results.directory <- '..'
subset.variable<-NULL
tab.suffix <- ''
rscripts.directory <- '/usr/local/share/perl5/5.40/PsN_5_6_0/R-scripts' # This is not used
tool.results.file <- 'vpc_results.csv'
theta.labels <- c('[1]   TVCL (L/h)','[2,3] TVV1 (L)','V2','Q','CLADA')
theta.fixed <- c(FALSE,FALSE,FALSE,FALSE,FALSE)
omega.labels <- c('IIV CL','IIV V')
omega.fixed <- c(FALSE,FALSE)
sigma.labels <- c('EPS(1), proportional','EPS(2)')
sigma.fixed <- c(FALSE,TRUE)
n.eta <- 2
n.eps <- 2
vpctab <- 'vpctab06'
have.loq.data <- TRUE
have.censored <- TRUE
is.categorical <- FALSE
is.tte <- FALSE
dv <- 'CONC'
idv <- 'TAD'
samples <- 200
setwd(working.directory)
############################################################################
#END OF AUTO-GENERATED PREAMBLE
#WHEN THIS FILE IS USED AS A TEMPLATE THIS LINE MUST LOOK EXACTLY LIKE THIS
# get libPaths
library(PsNR)
library(magrittr)
library(methods)
library(xpose4)
library(vpc)
library(ggplot2)
#add R_info to the meta file
R_info(directory=working.directory)
meta <- PsNR::metadata(working.directory)
if (is.tte) {
#data is in the model directory, go there to read input
setwd(dirname(PsNR::model_path(meta)))
capture.output(xpdb <- xpose4::xpose.data(PsNR::model_runno(meta)))
plots <- xpose4::kaplan.plot(object=xpdb, VPC=T)
#go back to vpc directory
setwd(working.directory)
} else if (is.categorical) {
plots <- xpose4::xpose.VPC.categorical(vpc.info=tool.results.file, vpctab=vpctab)
} else if (have.loq.data | have.censored) {
plots <- xpose4::xpose.VPC.both(vpc.info=tool.results.file, vpctab=vpctab)
} else {
plots <- xpose4::xpose.VPC(vpc.info=tool.results.file, vpctab=vpctab)
}
print(plots)
if (exists('mix')) {     # A mixture model is a special case
if (require("vpc")) {
cat("<BR>")
observations_tablefile <- paste0(working.directory, '/m1/vpc_original.npctab.dta')
simulations_tablefile <- paste0(working.directory, '/m1/vpc_simulation.1.npctab.dta')
obs <- read_nonmem_table(observations_tablefile)
sim <- read_nonmem_table(simulations_tablefile)
obs_phm <- read_nonmem_table(phm_obs_file)
sim_phm <- read_nonmem_table(phm_sim_file)
if (!exists('stratify_on')) {
stratify_on <- NULL
}
# Read name of IDV from vpc_results.csv
vpc_res <- read.csv(paste0(working.directory, '/vpc_results.csv'), skip=1, nrows=1, stringsAsFactors=FALSE)
idv <- trimws(vpc_res$Independent.variable)
vpc <- vpc::vpc(obs=obs, sim=sim, obs_cols=list(dv=dv, idv=idv), sim_cols=list(dv=dv, idv=idv), stratify=stratify_on, bins=bin_boundaries)
print(vpc)
plots_mixest <- mixture_vpc(obs, sim, obs_phm, sim_phm, dv=dv, idv=idv, bins=bin_boundaries, stratify_on=stratify_on)
plots_randomized <- mixture_vpc(obs, sim, obs_phm, sim_phm, dv=dv, idv=idv, bins=bin_boundaries, stratify_on=stratify_on, randomize=TRUE)
plots <- list()
for (i in 1:length(plots_mixest)) {
mixest <- plots_mixest[[i]]
randomized <- plots_randomized[[i]]
if (is.character(mixest) || is.character(randomized)) {     # An error message instead of plot
cat("\\pagebreak\n\n")
cat(p)
cat("\\pagebreak")
} else {
plots[[2*i - 1]] <- mixest
plots[[2*i]] <- randomized
}
}
print(gridExtra::marrangeGrob(plots, nrow=2, ncol=2, top=NULL, padding=0))
cat('<BR>')
plots <- list()
for (i in unique(obs_phm$SUBPOP)) { # Allowing cases with more than 2 mixtures
temp_obs <- obs_phm %>% dplyr::filter(SUBPOP == i) %>%
dplyr::arrange(PMIX) %>%
dplyr::mutate(rank=1:dplyr::n()) # Get rank for the plot
temp_sim <- sim_phm %>% dplyr::filter(SUBPOP == i) %>%
dplyr::group_by(replicate) %>% # Assuming replicate is the simulation number
dplyr::arrange(PMIX) %>%
dplyr::mutate(rank = 1:dplyr::n()) %>%  # Get rank for the plot by simulation
dplyr::group_by(rank) %>%
dplyr::summarise(per5=quantile(PMIX, probs=c(0.05)),
per95=quantile(PMIX, probs=c(0.95))) # Get percentiles among simulations
plots[[i]] <- ggplot() +
geom_ribbon(data=temp_sim, aes(rank, ymin=per5, ymax=per95), alpha=0.2) +
geom_text(data=temp_obs, aes(rank, PMIX, label=SUBJECT_NO), size=8) +
geom_hline(yintercept=0.5, linetype="dashed", size=2) +
theme_classic() +
theme(axis.text.y=element_text(size=20),
axis.title.y=element_blank(),
axis.ticks.y=element_line(size=3),
axis.ticks.length=unit(6, "pt"),
axis.ticks.x=element_blank(),
axis.title.x=element_text(size=25),
axis.text.x=element_blank()) +
xlab(paste0("SUBPOP=", i))
if (i > 1) {
plots[[i]] <- plots[[i]] + theme(axis.text.y=element_blank(), axis.ticks.y=element_blank())
}
}
left_axis = grid::textGrob("IPmix", gp=grid::gpar(font=2,fontsize=25), rot=90)
bottom_axis = grid::textGrob("Sorted ID", gp=grid::gpar(font=2,fontsize=25))
title = grid::textGrob("IPmix with uncertainty 5-95% CI", gp=grid::gpar(font=2,fontsize=35))
gridExtra::marrangeGrob(plots, nrow=1, ncol=2, top=title, left=left_axis, bottom=bottom_axis)
}
}
#| include: false
library(ggplot2)
library(tidyverse)
library(Hmisc)
data <- read.table("dataset.txt",
sep = " ",        # space-separated
na.strings = ".", # treat "." as NA
header = TRUE)
LLOQ <- 1                           # mg/L
data <- data %>%
mutate(DOSE = as.numeric(DOSE),
EVID = case_when(
is.na(CONC) & DOSE!=0 ~ 1,
CONC>=0 ~ 0,
is.na(CONC) & is.na(DOSE) ~ 2),
BLQ = case_when(
CONC<1 ~ 1,
CONC>=1 ~ 0,
is.na(CONC) ~ 0),
CONC_M7 = ifelse(CONC < 1, 0, CONC))
data <- data %>% group_by(ID) %>%
fill(c(BW),.direction = "downup") %>%
fill(c(ALB),.direction = "downup") %>%
fill(c(CREAT),.direction = "downup") %>%
ungroup()
data <- data %>%
group_by(ID) %>%
arrange(TIME, .by_group = TRUE) %>%
mutate(ADA = case_when(
ID %in% 71:75 ~ as.integer(cumany(ADA == 1)),
TRUE          ~ ADA)) %>%
ungroup()
data$DOSE = data$DOSE * data$BW # dose (mg) = dose (mg/kg) * body weight (kg)
write.table(data, file = "dataset_clean.txt", quote = FALSE, sep = " ", na = ".")
write.csv(data, file = "dataset_clean.csv", quote = FALSE, na = ".", row.names = FALSE)
datacor <- data %>%
select(ADA, AGE, ALB, BW, CREAT, COL, SEX)
rcorr(as.matrix(datacor), type = "spearman")$r %>%
signif(digits = 3)
rcorr(as.matrix(datacor), type = "spearman")$P %>%
signif(digits = 3)
length(unique(data$ID))
run06 <- read.table (file='run06', skip=1, header=T)
ggplot (run06 %>% filter(CONC > 1)) + # CWRES used because of FOCE-I
geom_point (aes(x=PRED, y=CWRES),  colour='darkblue') +
geom_abline(aes(slope=0, intercept=0), linetype='dashed') +
xlab('PRED') +
ylab('WRES')
ggplot (run06 %>% filter(CONC > 1)) +
geom_point (aes(x=PRED, y=CONC),  colour='darkblue') +
geom_abline(aes(slope=1, intercept=0), linetype='dashed') +
xlab('PRED') +
ylab('CONC')
ggplot (run06 %>% filter(CONC > 1)) + # no
geom_point (aes(x=TAD, y=CWRES),  colour='darkblue') +
geom_abline(aes(slope=0, intercept=0), linetype='dashed') +
xlab('PRED') +
ylab('WRES')
