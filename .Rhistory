theme_set(theme_bw())
ALB_REF_CL <- 31.88
ALB_REF_V <- 31.85
cs <- PMXForest::getCovStats(
data,
covariates = c("ALB","BW","CREAT"),
minLevels  = 10,
probs      = c(0.05, 0.95),
idVar      = "ID",
missVal    = -99,
nsig       = 3
)
dfCovs <- PMXForest::createInputForestData(list(
ADA = c(0, 1),
ALB = c(cs$ALB["5%"], cs$ALB["95%"]),
CREAT = c(cs$CREAT["5%"],  cs$CREAT["95%"])
))
covnames <- c(
"ADA negative","ADA positive",
"ALB 27 g/L","ALB 35 g/L",
"CREAT 0.45 L/d", "CREAT 1.54 L/d"
)
covariateGroupNames <- c("ADA","Albumin","Clearance")
functionListName <- c("CL","V")
# ---- Helpers (copy as-is) ----
.once_log <- local({ .done <- FALSE; function(expr) { if (!.done) { .done <<- TRUE; force(expr) } } })
.normalize_thetas <- function(thetas) {
if (is.data.frame(thetas)) thetas <- unlist(thetas, use.names = TRUE)
if (is.matrix(thetas))     thetas <- as.vector(thetas)
nm <- names(thetas)
if (is.null(nm) || any(is.na(nm)) || all(nm == "")) nm <- paste0("THETA", seq_along(thetas))
nm <- toupper(nm); nm <- gsub("\\s+", "", nm); nm <- gsub("[()]", "", nm); nm <- gsub("[^A-Z0-9_]", "", nm)
names(thetas) <- nm
thetas
}
.get_theta <- function(thetas, k) {
nm <- names(thetas)
candidates <- c(paste0("THETA", k), paste0("THETA(", k, ")"), paste0("THETA.", k), paste0("THETA_", k), paste0("THETA", k, "."))
for (c in candidates) { idx <- match(c, nm, nomatch = 0); if (idx > 0) return(unname(thetas[[idx]])) }
if (length(thetas) >= k) return(unname(thetas[[k]]))
stop(sprintf("Theta %d not found in 'thetas'. Available names: %s", k, paste(nm, collapse = ", ")))
}
# ---- Your covariate functions (robust) ----
f_CL <- function(thetas, df, ...) {
thetas <- .normalize_thetas(thetas)
.once_log(message("f_CL: thetas names = ", paste(names(thetas), collapse = ", ")))
ADA <- df[["ADA"]]
TH3 <- .get_theta(thetas, 3)
CLADA <- if (ADA == 0) 1 else (1 + TH3)
CLADA
}
f_V <- function(thetas, df, ...) {
thetas <- .normalize_thetas(thetas)
.once_log(message("f_V: thetas names = ", paste(names(thetas), collapse = ", ")))
ADA <- df[["ADA"]]; ALB <- df[["ALB"]]; CREAT <- df[["CREAT"]]
TH4 <- .get_theta(thetas, 4)
TH5 <- .get_theta(thetas, 5)
TH6 <- .get_theta(thetas, 6)
VADA <- if (ADA == 0) 1 else (1 + TH4)
VALB <- 1 + TH5 * (ALB - ALB_REF_V)
VCREAT <- (1 + TH6 * (CREAT - 1.03))
VADA * VALB * VCREAT
}
# ---- Data & parameters ----
extFile <- "final_backward_4.ext"
covFile <- "final_backward_4.cov"
dfSamplesCOV <- getSamples(covFile, extFile, n = 1000)
# Optional but recommended: normalize column names at the source
nm <- names(dfSamplesCOV)
nm <- toupper(nm); nm <- gsub("\\s+", "", nm); nm <- gsub("[()]", "", nm); nm <- gsub("[^A-Z0-9_]", "", nm)
names(dfSamplesCOV) <- nm
# ---- Compute ----
dfresCOV <- getForestDFSCM(
dfCovs           = dfCovs,
cdfCovsNames     = covnames,
functionList     = list(f_CL, f_V),
functionListName = functionListName,
noBaseThetas     = 6,
dfParameters     = dfSamplesCOV,
iMiss            = -99
)
F1 <- forestPlot(dfresCOV,parameters= c("CL", "V"),
groupNameLabels    = covariateGroupNames,
referenceInfo      = "Reference: (CL) ADA = 0 (negative), ALB = 31.88 g/L; (V1) ALB = 31.85, BW = 65.93 kg",
noVar              = 4,
size = theme_get()$text$size * 0.92,
tabTextSize = 10)
ggsave("PMXForestSCMPlus.png", plot = F1, width = 11, height = 7, units = "in")
F1 <- forestPlot(dfresCOV,parameters= c("CL", "V"),
groupNameLabels    = covariateGroupNames,
referenceInfo      = "Reference: (CL) ADA = 0 (negative), ALB = 31.88 g/L; (V1) ALB = 31.85 g/L, CREAT = 1.03 mg/dL",
noVar              = 4,
size = theme_get()$text$size * 0.92,
tabTextSize = 10)
ggsave("PMXForestSCMPlus.png", plot = F1, width = 11, height = 7, units = "in")
#START OF AUTO-GENERATED PREAMBLE, WILL BE OVERWRITTEN WHEN THIS FILE IS USED AS A TEMPLATE
#Created 2026-01-06 at 14:59
xpose.runno <- '4.mod'
toolname <- 'vpc'
pdf.filename <- paste0('PsN_',toolname,'_plots.pdf')
working.directory<-'/home/ali/Documents/GitHub/Modelling-project/scm_run01_cont/final_model/vpc_final4/'
results.directory <- '..'
subset.variable<-NULL
tab.suffix <- ''
rscripts.directory <- '/usr/local/share/perl5/5.40/PsN_5_6_0/R-scripts' # This is not used
tool.results.file <- 'vpc_results.csv'
theta.labels <- c('CL (L/d) [1]','V (L) [2,3]','CLADA','VADA','VALB','VCREAT')
theta.fixed <- c(FALSE,FALSE,FALSE,FALSE,FALSE,FALSE)
omega.labels <- c('IIV CL (value obtained from SCM+)','IIV V')
omega.fixed <- c(FALSE,FALSE)
sigma.labels <- c('EPS(1), proportional (value obtained from SCM+)','EPS(2)')
sigma.fixed <- c(FALSE,TRUE)
n.eta <- 2
n.eps <- 2
vpctab <- 'vpctab'
have.loq.data <- TRUE
have.censored <- FALSE
is.categorical <- FALSE
is.tte <- FALSE
dv <- 'CONC_M7'
idv <- 'TAD'
samples <- 1000
setwd(working.directory)
############################################################################
#END OF AUTO-GENERATED PREAMBLE
#WHEN THIS FILE IS USED AS A TEMPLATE THIS LINE MUST LOOK EXACTLY LIKE THIS
# get libPaths
library(PsNR)
library(magrittr)
library(methods)
library(xpose4)
library(vpc)
library(ggplot2)
#add R_info to the meta file
R_info(directory=working.directory)
meta <- PsNR::metadata(working.directory)
if (is.tte) {
#data is in the model directory, go there to read input
setwd(dirname(PsNR::model_path(meta)))
capture.output(xpdb <- xpose4::xpose.data(PsNR::model_runno(meta)))
plots <- xpose4::kaplan.plot(object=xpdb, VPC=T)
#go back to vpc directory
setwd(working.directory)
} else if (is.categorical) {
plots <- xpose4::xpose.VPC.categorical(vpc.info=tool.results.file, vpctab=vpctab)
} else if (have.loq.data | have.censored) {
plots <- xpose4::xpose.VPC.both(vpc.info=tool.results.file, vpctab=vpctab)
} else {
plots <- xpose4::xpose.VPC(vpc.info=tool.results.file, vpctab=vpctab)
}
print(plots)
library(PMXForest)
library(ggplot2)
theme_set(theme_bw())
ALB_REF_V1 <- 31.84
BW_REF_V1  <- 65.91
cs <- PMXForest::getCovStats(
data,
covariates = c("ALB","BW"),
minLevels  = 10,
probs      = c(0.05, 0.95),
idVar      = "ID",
missVal    = -99,
nsig       = 3
)
dfCovs <- PMXForest::createInputForestData(list(
ADA = c(0, 1),
ALB = c(cs$ALB["5%"], cs$ALB["95%"]),
BW = c(cs$BW["5%"],  cs$BW["95%"])
))
covnames <- c(
"ADA negative","ADA positive",
"ALB 27 g/L","ALB 35 g/L",
"BW 0.45 L/d", "BW 1.54 L/d"
)
covariateGroupNames <- c("ADA","Albumin","Clearance")
functionListName <- c("CL","V")
# ---- Helpers (copy as-is) ----
.once_log <- local({ .done <- FALSE; function(expr) { if (!.done) { .done <<- TRUE; force(expr) } } })
.normalize_thetas <- function(thetas) {
if (is.data.frame(thetas)) thetas <- unlist(thetas, use.names = TRUE)
if (is.matrix(thetas))     thetas <- as.vector(thetas)
nm <- names(thetas)
if (is.null(nm) || any(is.na(nm)) || all(nm == "")) nm <- paste0("THETA", seq_along(thetas))
nm <- toupper(nm); nm <- gsub("\\s+", "", nm); nm <- gsub("[()]", "", nm); nm <- gsub("[^A-Z0-9_]", "", nm)
names(thetas) <- nm
thetas
}
.get_theta <- function(thetas, k) {
nm <- names(thetas)
candidates <- c(paste0("THETA", k), paste0("THETA(", k, ")"), paste0("THETA.", k), paste0("THETA_", k), paste0("THETA", k, "."))
for (c in candidates) { idx <- match(c, nm, nomatch = 0); if (idx > 0) return(unname(thetas[[idx]])) }
if (length(thetas) >= k) return(unname(thetas[[k]]))
stop(sprintf("Theta %d not found in 'thetas'. Available names: %s", k, paste(nm, collapse = ", ")))
}
View(dfCovs)
library(PMXForest)
library(ggplot2)
theme_set(theme_bw())
ALB_REF_V1 <- 31.84
cs <- PMXForest::getCovStats(
data,
covariates = c("ALB"),
minLevels  = 10,
probs      = c(0.05, 0.95),
idVar      = "ID",
missVal    = -99,
nsig       = 3
)
dfCovs <- PMXForest::createInputForestData(list(
ADA = c(0, 1),
ALB = c(cs$ALB["5%"], cs$ALB["95%"]),
))
library(PMXForest)
library(ggplot2)
theme_set(theme_bw())
ALB_REF_V1 <- 31.84
cs <- PMXForest::getCovStats(
data,
covariates = "ALB",
minLevels  = 10,
probs      = c(0.05, 0.95),
idVar      = "ID",
missVal    = -99,
nsig       = 3
)
dfCovs <- PMXForest::createInputForestData(list(
ADA = c(0, 1),
ALB = c(cs$ALB["5%"], cs$ALB["95%"]),
))
library(PMXForest)
library(ggplot2)
theme_set(theme_bw())
ALB_REF_V1 <- 31.84
cs <- PMXForest::getCovStats(
data,
covariates = "ALB",
minLevels  = 10,
probs      = c(0.05, 0.95),
idVar      = "ID",
missVal    = -99,
nsig       = 3
)
dfCovs <- PMXForest::createInputForestData(list(
ADA = c(0, 1),
ALB = c(cs$ALB["5%"], cs$ALB["95%"]),
))
View(cs)
ALB = c(cs$ALB["5%"], cs$ALB["95%"])
dfCovs <- PMXForest::createInputForestData(list(
ADA = c(0, 1),
ALB = c(cs$ALB["5%"], cs$ALB["95%"]),
))
library(PMXForest)
library(ggplot2)
theme_set(theme_bw())
ALB_REF_V1 <- 31.84
cs <- PMXForest::getCovStats(
data,
covariates = "ALB",
minLevels  = 10,
probs      = c(0.05, 0.95),
idVar      = "ID",
missVal    = -99,
nsig       = 3
)
dfCovs <- PMXForest::createInputForestData(list(
ADA = c(0, 1),
ALB = c(cs$ALB["5%"], cs$ALB["95%"]),
))
library(PMXForest)
library(ggplot2)
theme_set(theme_bw())
ALB_REF_V1 <- 31.84
cs <- PMXForest::getCovStats(
data,
covariates = "ALB",
minLevels  = 10,
probs      = c(0.05, 0.95),
idVar      = "ID",
missVal    = -99,
nsig       = 3
)
dfCovs <- PMXForest::createInputForestData(list(
ADA = c(0, 1),
ALB = c(cs$ALB["5%"], cs$ALB["95%"]),
))
library(PMXForest)
library(ggplot2)
theme_set(theme_bw())
ALB_REF_V1 <- 31.84
cs <- PMXForest::getCovStats(
data,
covariates = "ALB",
minLevels  = 10,
probs      = c(0.05, 0.95),
idVar      = "ID",
missVal    = -99,
nsig       = 3
)
dfCovs <- PMXForest::createInputForestData(list(
ADA = c(0, 1),
ALB = c(cs$ALB["5%"], cs$ALB["95%"])
))
covnames <- c(
"ADA negative","ADA positive",
"ALB 27 g/L","ALB 35 g/L"
)
covariateGroupNames <- c("ADA","Albumin")
functionListName <- c("CL","V1")
# ---- Helpers (copy as-is) ----
.once_log <- local({ .done <- FALSE; function(expr) { if (!.done) { .done <<- TRUE; force(expr) } } })
.normalize_thetas <- function(thetas) {
if (is.data.frame(thetas)) thetas <- unlist(thetas, use.names = TRUE)
if (is.matrix(thetas))     thetas <- as.vector(thetas)
nm <- names(thetas)
if (is.null(nm) || any(is.na(nm)) || all(nm == "")) nm <- paste0("THETA", seq_along(thetas))
nm <- toupper(nm); nm <- gsub("\\s+", "", nm); nm <- gsub("[()]", "", nm); nm <- gsub("[^A-Z0-9_]", "", nm)
names(thetas) <- nm
thetas
}
.get_theta <- function(thetas, k) {
nm <- names(thetas)
candidates <- c(paste0("THETA", k), paste0("THETA(", k, ")"), paste0("THETA.", k), paste0("THETA_", k), paste0("THETA", k, "."))
for (c in candidates) { idx <- match(c, nm, nomatch = 0); if (idx > 0) return(unname(thetas[[idx]])) }
if (length(thetas) >= k) return(unname(thetas[[k]]))
stop(sprintf("Theta %d not found in 'thetas'. Available names: %s", k, paste(nm, collapse = ", ")))
}
#START OF AUTO-GENERATED PREAMBLE, WILL BE OVERWRITTEN WHEN THIS FILE IS USED AS A TEMPLATE
#Created 2026-01-07 at 11:24
xpose.runno <- '12.mod'
toolname <- 'vpc'
pdf.filename <- paste0('PsN_',toolname,'_plots.pdf')
working.directory<-'/home/ali/Documents/GitHub/Modelling-project/vpc_run12/'
results.directory <- '..'
subset.variable<-NULL
tab.suffix <- ''
rscripts.directory <- '/usr/local/share/perl5/5.40/PsN_5_6_0/R-scripts' # This is not used
tool.results.file <- 'vpc_results.csv'
theta.labels <- c('[1]   CL (L/d)','[2,3] V1  (L)','V2','Q','CLADA','V1ALB1')
theta.fixed <- c(FALSE,FALSE,FALSE,FALSE,FALSE,FALSE)
omega.labels <- c('IIV CL','IIV V1')
omega.fixed <- c(FALSE,FALSE)
sigma.labels <- c('EPS(1), proportional','EPS(2)')
sigma.fixed <- c(FALSE,TRUE)
n.eta <- 2
n.eps <- 2
vpctab <- 'vpctab12'
have.loq.data <- TRUE
have.censored <- FALSE
is.categorical <- FALSE
is.tte <- FALSE
dv <- 'CONC_M7'
idv <- 'TAD'
samples <- 1000
setwd(working.directory)
############################################################################
#END OF AUTO-GENERATED PREAMBLE
#WHEN THIS FILE IS USED AS A TEMPLATE THIS LINE MUST LOOK EXACTLY LIKE THIS
# get libPaths
library(PsNR)
library(magrittr)
library(methods)
library(xpose4)
library(vpc)
library(ggplot2)
#add R_info to the meta file
R_info(directory=working.directory)
meta <- PsNR::metadata(working.directory)
if (is.tte) {
#data is in the model directory, go there to read input
setwd(dirname(PsNR::model_path(meta)))
capture.output(xpdb <- xpose4::xpose.data(PsNR::model_runno(meta)))
plots <- xpose4::kaplan.plot(object=xpdb, VPC=T)
#go back to vpc directory
setwd(working.directory)
} else if (is.categorical) {
plots <- xpose4::xpose.VPC.categorical(vpc.info=tool.results.file, vpctab=vpctab)
} else if (have.loq.data | have.censored) {
plots <- xpose4::xpose.VPC.both(vpc.info=tool.results.file, vpctab=vpctab)
} else {
plots <- xpose4::xpose.VPC(vpc.info=tool.results.file, vpctab=vpctab)
}
print(plots)
gc()
#| include: false
library(ggplot2)
library(tidyverse)
library(Hmisc)
library(PMXForest)
library(patchwork)
#| include: false
data <- read.table("dataset.txt", sep = " ",       # space-separated
header = TRUE, na.strings = ".") # treat "." as NA
LLOQ <- 1 # mg/L
data <- data %>% mutate(DOSE = as.numeric(DOSE),
EVID = case_when(is.na(CONC) & DOSE!=0 ~ 1,
CONC>=0 ~ 0,
is.na(CONC) & is.na(DOSE) ~ 2),
BLQ = case_when(CONC<1 ~ 1,
CONC>=1 ~ 0,
is.na(CONC) ~ 0),
CONC_M7 = ifelse(CONC < 1, 0, CONC)) %>%
group_by(ID) %>%
fill(c(ALB, BW, CREAT),.direction = "downup") %>%
arrange(TIME, .by_group = TRUE) %>%
mutate(ADA = case_when(
ID %in% 71:75 ~ as.integer(cumany(ADA == 1)),
TRUE          ~ ADA)) %>%
ungroup()
data$DOSE = data$DOSE * data$BW # dose (mg) = dose (mg/kg) * body weight (kg)
write.csv(data, file = "dataset_clean.csv", quote = FALSE,
na = ".", row.names = FALSE)
gc()
View(data)
data7d <- data
data7d[`TIME`] = data7d[`TIME`].round()
data7d <- data %>% mutate_if(TIME, ~round(., 1))
#| include: false
library(ggplot2)
library(tidyverse)
library(Hmisc)
library(PMXForest)
library(patchwork)
data7d <- data %>% mutate_if(TIME, ~round(., 1))
data7d <- data %>% mutate_if(data$TIME, ~round(., 1))
data7d <- data %>% mutate_if(TIME, ~round(., 1))
data7d <- data %>% mutate_if('TIME', ~round(., 1))
data7d <- data %>% mutate_if(vars('TIME'), ~round(., 1))
data7d <- data %>% mutate(TIME = as.numeric(TIME)) %>%
mutate_if(vars(TIME), ~round(., 1))
data7d <- data %>% mutate(TIME = as.numeric(TIME)) %>%
mutate_if(var(TIME), ~round(., 1))
View(data)
data %>% mutate(TIME = as.numeric(TIME)) %>%
mutate_if(var(TIME), ~round(., 1))
data %>% mutate(TIME = as.numeric(TIME)) %>%
mutate_if(vars(TIME), funs(round(.))
data %>% mutate(TIME = as.numeric(TIME)) %>%
mutate_if(vars(TIME), funs(round(.)))
#| include: false
library(ggplot2)
library(tidyverse)
library(Hmisc)
library(PMXForest)
library(patchwork)
#| include: false
data <- read.table("dataset.txt", sep = " ",       # space-separated
header = TRUE, na.strings = ".") # treat "." as NA
LLOQ <- 1 # mg/L
data <- data %>% mutate(DOSE = as.numeric(DOSE),
EVID = case_when(is.na(CONC) & DOSE!=0 ~ 1,
CONC>=0 ~ 0,
is.na(CONC) & is.na(DOSE) ~ 2),
BLQ = case_when(CONC<1 ~ 1,
CONC>=1 ~ 0,
is.na(CONC) ~ 0),
CONC_M7 = ifelse(CONC < 1, 0, CONC)) %>%
group_by(ID) %>%
fill(c(ALB, BW, CREAT),.direction = "downup") %>%
arrange(TIME, .by_group = TRUE) %>%
mutate(ADA = case_when(
ID %in% 71:75 ~ as.integer(cumany(ADA == 1)),
TRUE          ~ ADA)) %>%
ungroup()
data$DOSE = data$DOSE * data$BW # dose (mg) = dose (mg/kg) * body weight (kg)
write.csv(data, file = "dataset_clean.csv", quote = FALSE,
na = ".", row.names = FALSE)
data %>% mutate(TIME = as.numeric(TIME)) %>%
mutate_if(vars(TIME), funs(round(.)))
data7d <- data %>%
mutate(
TIME = as.numeric(TIME),   # ensure numeric
TIME = round(TIME)         # round to nearest integer
)
View(data7d)
ggplot(data7d %>% filter(TIME = 7),
aes(x = TIME,
y = CONC_M7)) +
geom_boxplot() +
geom_violin() +
theme_minimal()
ggplot(data7d %>% filter(TIME == 7),
aes(x = TIME,
y = CONC_M7)) +
geom_boxplot() +
geom_violin() +
theme_minimal()
ggplot(data7d %>% filter(TIME == 7),
aes(x = TIME,
y = CONC_M7)) +
geom_violin() +
geom_boxplot() +
theme_minimal()
ggplot(data7d %>% filter(TIME == 7),
aes(x = TIME,
y = CONC_M7)) +
geom_violin(trim = FALSE) +
geom_boxplot(width = 0.1, outlier.shape = 16, outlier.size = 2, outlier.colour = "red") +
theme_minimal()
ggplot(data7d %>% filter(TIME == 7),
aes(x = TIME,
y = CONC)) +
geom_violin(trim = FALSE) +
geom_boxplot(width = 0.1, outlier.shape = 16, outlier.size = 2, outlier.colour = "red") +
theme_minimal()
ggplot(data7d %>% filter(TIME == 7),
aes(x = TIME,
y = CONC_M7)) +
geom_violin(trim = FALSE) +
geom_boxplot(width = 0.1, outlier.shape = 16, outlier.size = 2, outlier.colour = "red") +
theme_minimal()
